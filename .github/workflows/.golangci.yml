name: static check
on:
  push:
  pull_request:
    paths:
      - "**.go"
      - .github/workflows/golangci.yml

jobs:
  golangci-lint:
    name: golangci-lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v3

      - name: set up go
        run: go mod download

      - name: Confirm GO
        run: go env && pwd

      - name: Run gofmt
        run: gofmt -l -s -w *.go

      - name: Install goimports
        run:  go install golang.org/x/tools/cmd/goimports@latest
        env:
          GO111MODULE: on

      - name: Check contents of $HOME/go/bin
        run: ls -l $HOME/go/bin

      - name: Check goimports installation directory
        run: GOPATH
        env:
          PATH: ${{ runner.tool_cache }}/go/1.21.3/x64/bin:${{ env.PATH }}

      - name: Check goimports version2
        run: goimports version

      - name: Check goimports version
        run: goimports version
        env:
          PATH: ${{ runner.tool_cache }}/go/1.21.3/x64/bin:${{ env.PATH }}


      - name: Run goimports
        run: goimports -w *.go


      - name: golangci-lint
        uses: reviewdog/action-golangci-lint@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          golangci_lint_flags: "--config=./.golangci.yml ./..."
          fail_on_error: true
          reporter: "github-pr-review"

      - name: Slack Notification on Failure
        id: slack
        uses: slackapi/slack-github-action@v1.24.0
        if: ${{ failure() }}
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "„É™„Éù„Ç∏„Éà„É™: ${{ github.repository }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "„Éá„Éó„É≠„Ç§Â§±Êïó„Åó„Åæ„Åó„Åüüò¢\n result: ${{ job.status }}\n ${{ github.workflow }} Action: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
